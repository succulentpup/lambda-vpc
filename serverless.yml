service: ${self:custom.package.name}

plugins:
  - serverless-esbuild
  - serverless-iam-roles-per-function
  - serverless-offline  # serverless-esbuild should precede serverless-offline

package:
  individually: true

provider:
  name: aws
  architecture: arm64
  runtime: nodejs14.x
  versionFunctions: false
  region: ${opt:region, 'eu-west-2'} # ChangeIt
  vpc:
    securityGroupIds:
      - Ref: LambdaSecurityGroup
    subnetIds:
      - Ref: PrivateSubnet1
  stage: ${opt:stage, 'dev'}
  environment:
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: 1 # useful for performance optimization, ref: http keep alive
    REGION: ${self:provider.region}

custom:
  env: ${file(./env/${self:provider.stage}.yml)}
  base: ${self:service}-${self:provider.stage}
  host: ${self:custom.env.DOMAIN}.${self:custom.env.ROOT_DOMAIN}
  package: ${file(./package.json)}
  UsageDetailsBucketName: usage-details-sg
  esbuild:
    packager: yarn
    bundle: true
    minify: true
    sourcemap: true
    keepNames: true
#    external:
#      - lodash
#    watch:
#     # anymatch-compatible definition (https://github.com/es128/anymatch)
#     pattern: [ './index.ts', 'src/**/*.ts' ] # default .
#     ignore: [ '.serverless/**/*', '.build' ] # default ['.build', 'dist', 'node_modules']

functions: # add your functions
  health:
    handler: src/health/index.handler
    name: ${self:custom.base}-health
    description: used as heartbeat lambda for this service
    vpc: ~  # excluding this function from the VPC defined by this service
    events:
      - http:
          method: get
          cors: true
          path: health
  parseUsageDetails:
    handler: src/parseUsageDetails/index.handler
    name: ${self:custom.base}-parseUsageDetails
    description: listens to usage-details-sg bucket/CSVFiles path, parses and send to SQS
    environment:
      BUCKET: ${self:custom.UsageDetailsBucketName}
    iamRoleStatements:
      - Effect: Allow
        Action:
          - s3:ListBucket
        Resource:
          - arn:aws:s3:::${self:custom.UsageDetailsBucketName}
      - Effect: Allow
        Action:
          - s3:GetObject
        Resource:
          - arn:aws:s3:::${self:custom.UsageDetailsBucketName}/CSVFiles/*
    events:
      - s3:
          bucket: ${self:custom.UsageDetailsBucketName}
          event: s3:ObjectCreated:*
          rules:
            - prefix: CSVFiles/
            - suffix: .csv
          existing: true
resources:
  - ${file(resources/vpc.yml)}
  - ${file(resources/s3-usageDetails.yml)}
  # DynamoDB Tables
  # Output
